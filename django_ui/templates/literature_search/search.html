{% extends 'core/base.html' %} {% load static %} {% block title %}Literature
Search - Research Assistant{% endblock %} {% block extra_css %}
<style>
  .search-filters {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .paper-card {
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    transition: box-shadow 0.3s ease;
  }

  .paper-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .paper-title {
    color: #2c3e50;
    text-decoration: none;
    font-weight: 600;
  }

  .paper-title:hover {
    color: #3498db;
  }

  .bookmark-btn {
    border: none;
    background: none;
    color: #6c757d;
    font-size: 1.2em;
    transition: color 0.3s ease;
  }

  .bookmark-btn:hover,
  .bookmark-btn.bookmarked {
    color: #ffc107;
  }

  .loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
  }

  .source-badge {
    font-size: 0.75em;
    padding: 0.25em 0.5em;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <!-- Search Sidebar -->
    <div class="col-lg-3 col-md-4">
      <div class="search-filters">
        <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Search Filters</h5>

        <form id="searchForm">
          <!-- Search Query -->
          <div class="mb-3">
            <label for="searchQuery" class="form-label">Search Query</label>
            <input
              type="text"
              class="form-control"
              id="searchQuery"
              name="query"
              placeholder="Enter keywords, topics, or authors..."
            />
          </div>

          <!-- Sources -->
          <div class="mb-3">
            <label class="form-label">Sources</label>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="sources"
                value="arxiv"
                id="source-arxiv"
                checked
              />
              <label class="form-check-label" for="source-arxiv"> arXiv </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="sources"
                value="pubmed"
                id="source-pubmed"
                checked
              />
              <label class="form-check-label" for="source-pubmed">
                PubMed
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="sources"
                value="semantic_scholar"
                id="source-semantic"
                checked
              />
              <label class="form-check-label" for="source-semantic">
                Semantic Scholar
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="sources"
                value="manual"
                id="source-manual"
              />
              <label class="form-check-label" for="source-manual">
                Manual Uploads
              </label>
            </div>
          </div>

          <!-- Date Range -->
          <div class="mb-3">
            <label class="form-label">Publication Date Range</label>
            <div class="row">
              <div class="col-6">
                <input
                  type="date"
                  class="form-control"
                  name="date_from"
                  id="dateFrom"
                />
                <small class="text-muted">From</small>
              </div>
              <div class="col-6">
                <input
                  type="date"
                  class="form-control"
                  name="date_to"
                  id="dateTo"
                />
                <small class="text-muted">To</small>
              </div>
            </div>
          </div>

          <!-- Max Results -->
          <div class="mb-3">
            <label for="maxResults" class="form-label">Max Results</label>
            <select class="form-select" name="max_results" id="maxResults">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search me-2"></i>Search
          </button>
        </form>
      </div>

      <!-- Recent Searches -->
      {% if recent_searches %}
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-history me-2"></i>Recent Searches
          </h6>
        </div>
        <div class="card-body">
          {% for search in recent_searches %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <a
              href="#"
              class="text-decoration-none recent-search"
              data-query="{{ search.query }}"
            >
              {{ search.query|truncatechars:30 }}
            </a>
            <small class="text-muted">{{ search.result_count }}</small>
          </div>
          {% endfor %}
          <a
            href="{% url 'literature_search:history' %}"
            class="btn btn-sm btn-outline-secondary w-100 mt-2"
          >
            View All History
          </a>
        </div>
      </div>
      {% endif %}

      <!-- Quick Stats -->
      <div class="card mt-3">
        <div class="card-body text-center">
          <h5 class="text-primary">{{ total_papers|default:0 }}</h5>
          <small class="text-muted">Papers in Database</small>
        </div>
      </div>
    </div>

    <!-- Search Results -->
    <div class="col-lg-9 col-md-8">
      <div id="searchResults">
        <!-- Welcome Message -->
        <div id="welcomeMessage" class="text-center py-5">
          <i class="fas fa-search fa-4x text-primary mb-4"></i>
          <h3 class="mb-3">Advanced Literature Search</h3>
          <p class="text-muted lead">
            Search through millions of research papers from multiple sources
            including arXiv, PubMed, and Semantic Scholar.
          </p>
          <div class="row mt-4">
            <div class="col-md-4">
              <i class="fas fa-database fa-2x text-success mb-2"></i>
              <h5>Multiple Sources</h5>
              <p class="text-muted">
                Access papers from arXiv, PubMed, Semantic Scholar, and more
              </p>
            </div>
            <div class="col-md-4">
              <i class="fas fa-filter fa-2x text-info mb-2"></i>
              <h5>Advanced Filters</h5>
              <p class="text-muted">
                Filter by date, source, authors, and keywords
              </p>
            </div>
            <div class="col-md-4">
              <i class="fas fa-bookmark fa-2x text-warning mb-2"></i>
              <h5>Save & Organize</h5>
              <p class="text-muted">
                Bookmark papers and manage your research library
              </p>
            </div>
          </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Searching literature...</p>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" style="display: none">
          <div
            id="resultsHeader"
            class="d-flex justify-content-between align-items-center mb-3"
          >
            <h4 id="resultsTitle">Search Results</h4>
            <div class="d-flex gap-2">
              <button
                class="btn btn-sm btn-outline-secondary"
                id="exportResults"
              >
                <i class="fas fa-download me-1"></i>Export
              </button>
            </div>
          </div>

          <div id="resultsList"></div>

          <div id="resultsFooter" class="text-center mt-4">
            <button
              class="btn btn-outline-primary"
              id="loadMoreResults"
              style="display: none"
            >
              Load More Results
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Paper Detail Modal -->
<div class="modal fade" id="paperModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paperModalTitle">Paper Details</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="paperModalBody">
        <!-- Paper details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <a href="#" class="btn btn-primary" id="paperModalLink" target="_blank">
          <i class="fas fa-external-link-alt me-1"></i>View Full Paper
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchForm = document.getElementById("searchForm");
    const searchResults = document.getElementById("searchResults");
    const welcomeMessage = document.getElementById("welcomeMessage");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const resultsContainer = document.getElementById("resultsContainer");
    const resultsList = document.getElementById("resultsList");
    const resultsTitle = document.getElementById("resultsTitle");

    // Search form submission
    searchForm.addEventListener("submit", function (e) {
      e.preventDefault();
      performSearch();
    });

    // Recent search clicks
    document.querySelectorAll(".recent-search").forEach((link) => {
      link.addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("searchQuery").value = this.dataset.query;
        performSearch();
      });
    });

    function performSearch() {
      const formData = new FormData(searchForm);
      const query = formData.get("query");

      if (!query.trim()) {
        alert("Please enter a search query");
        return;
      }

      // Show loading state
      welcomeMessage.style.display = "none";
      resultsContainer.style.display = "none";
      loadingSpinner.style.display = "block";

      // Prepare data
      const searchData = {
        query: query,
        sources: formData.getAll("sources"),
        date_from: formData.get("date_from"),
        date_to: formData.get("date_to"),
        max_results: formData.get("max_results"),
      };

      // Perform search
      fetch('{% url "literature_search:perform_search" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify(searchData),
      })
        .then((response) => response.json())
        .then((data) => {
          loadingSpinner.style.display = "none";

          if (data.success) {
            displayResults(data);
          } else {
            showError(data.error);
          }
        })
        .catch((error) => {
          loadingSpinner.style.display = "none";
          showError("An error occurred during search");
          console.error("Search error:", error);
        });
    }

    function displayResults(data) {
      resultsTitle.textContent = `Search Results for "${data.query}" (${data.total_count} found)`;

      if (data.results.length === 0) {
        resultsList.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-search-minus fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Results Found</h5>
                    <p class="text-muted">Try adjusting your search terms or filters</p>
                </div>
            `;
      } else {
        resultsList.innerHTML = data.results
          .map((paper) => createPaperCard(paper))
          .join("");
      }

      resultsContainer.style.display = "block";

      // Add event listeners to bookmark buttons
      document.querySelectorAll(".bookmark-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          toggleBookmark(this.dataset.paperId, this);
        });
      });

      // Add event listeners to paper title links
      document.querySelectorAll(".paper-detail-link").forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          showPaperDetail(this.dataset.paperId);
        });
      });
    }

    function createPaperCard(paper) {
      const authors = Array.isArray(paper.authors)
        ? paper.authors.slice(0, 5).join(", ")
        : paper.authors || "Unknown authors";
      const authorsDisplay =
        paper.authors && paper.authors.length > 5
          ? authors + " et al."
          : authors;

      return `
            <div class="paper-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="paper-title mb-0">
                        <a href="#" class="paper-detail-link" data-paper-id="${
                          paper.id
                        }">
                            ${paper.title}
                        </a>
                    </h6>
                    <div class="d-flex gap-2">
                        <span class="badge bg-secondary source-badge">${
                          paper.source
                        }</span>
                        {% if user.is_authenticated %}
                        <button class="bookmark-btn ${
                          paper.is_bookmarked ? "bookmarked" : ""
                        }" 
                                data-paper-id="${paper.id}" title="Bookmark">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <p class="text-muted mb-2">
                    <i class="fas fa-users me-1"></i>${authorsDisplay}
                </p>
                
                <p class="text-secondary mb-2">${paper.abstract}</p>
                
                <div class="d-flex gap-3 small text-muted">
                    ${
                      paper.publication_date
                        ? `
                        <span><i class="fas fa-calendar me-1"></i>${new Date(
                          paper.publication_date
                        ).getFullYear()}</span>
                    `
                        : ""
                    }
                    ${
                      paper.journal
                        ? `
                        <span><i class="fas fa-journal-whills me-1"></i>${paper.journal}</span>
                    `
                        : ""
                    }
                    ${
                      paper.citation_count
                        ? `
                        <span><i class="fas fa-quote-right me-1"></i>${paper.citation_count} citations</span>
                    `
                        : ""
                    }
                    ${
                      paper.doi
                        ? `
                        <span><i class="fas fa-external-link-alt me-1"></i>DOI: ${paper.doi}</span>
                    `
                        : ""
                    }
                </div>
                
                <div class="mt-2">
                    ${
                      paper.pdf_url
                        ? `
                        <a href="${paper.pdf_url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                            <i class="fas fa-file-pdf me-1"></i>PDF
                        </a>
                    `
                        : ""
                    }
                    ${
                      paper.external_url
                        ? `
                        <a href="${paper.external_url}" target="_blank" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-external-link-alt me-1"></i>View Online
                        </a>
                    `
                        : ""
                    }
                </div>
            </div>
        `;
    }

    function toggleBookmark(paperId, button) {
      fetch('{% url "literature_search:bookmark_paper" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          paper_id: paperId,
          action: "toggle",
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            if (data.bookmarked) {
              button.classList.add("bookmarked");
            } else {
              button.classList.remove("bookmarked");
            }
          }
        })
        .catch((error) => {
          console.error("Bookmark error:", error);
        });
    }

    function showPaperDetail(paperId) {
      fetch(
        `{% url 'literature_search:paper_detail' paper_id='PLACEHOLDER' %}`.replace(
          "PLACEHOLDER",
          paperId
        ),
        {
          headers: {
            Accept: "application/json",
          },
        }
      )
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            displayPaperModal(data.paper);
          }
        })
        .catch((error) => {
          console.error("Paper detail error:", error);
        });
    }

    function displayPaperModal(paper) {
      document.getElementById("paperModalTitle").textContent = paper.title;
      document.getElementById("paperModalBody").innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h6>Abstract</h6>
                    <p>${paper.abstract}</p>
                    
                    ${
                      paper.summary
                        ? `
                        <h6>AI Summary</h6>
                        <p class="bg-light p-3 rounded">${paper.summary}</p>
                    `
                        : ""
                    }
                    
                    ${
                      paper.keywords && paper.keywords.length > 0
                        ? `
                        <h6>Keywords</h6>
                        <div class="mb-3">
                            ${paper.keywords
                              .map(
                                (keyword) =>
                                  `<span class="badge bg-light text-dark me-1">${keyword}</span>`
                              )
                              .join("")}
                        </div>
                    `
                        : ""
                    }
                </div>
                
                <div class="col-md-4">
                    <h6>Details</h6>
                    <dl class="row">
                        <dt class="col-sm-4">Authors:</dt>
                        <dd class="col-sm-8">${
                          Array.isArray(paper.authors)
                            ? paper.authors.join(", ")
                            : paper.authors
                        }</dd>
                        
                        ${
                          paper.publication_date
                            ? `
                            <dt class="col-sm-4">Published:</dt>
                            <dd class="col-sm-8">${new Date(
                              paper.publication_date
                            ).toLocaleDateString()}</dd>
                        `
                            : ""
                        }
                        
                        ${
                          paper.journal
                            ? `
                            <dt class="col-sm-4">Journal:</dt>
                            <dd class="col-sm-8">${paper.journal}</dd>
                        `
                            : ""
                        }
                        
                        ${
                          paper.doi
                            ? `
                            <dt class="col-sm-4">DOI:</dt>
                            <dd class="col-sm-8"><code>${paper.doi}</code></dd>
                        `
                            : ""
                        }
                        
                        <dt class="col-sm-4">Citations:</dt>
                        <dd class="col-sm-8">${paper.citation_count || 0}</dd>
                        
                        <dt class="col-sm-4">Source:</dt>
                        <dd class="col-sm-8"><span class="badge bg-secondary">${
                          paper.source
                        }</span></dd>
                    </dl>
                </div>
            </div>
        `;

      const modalLink = document.getElementById("paperModalLink");
      if (paper.external_url) {
        modalLink.href = paper.external_url;
        modalLink.style.display = "inline-block";
      } else {
        modalLink.style.display = "none";
      }

      new bootstrap.Modal(document.getElementById("paperModal")).show();
    }

    function showError(message) {
      resultsList.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
      resultsContainer.style.display = "block";
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
